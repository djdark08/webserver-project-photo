<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agonia Server</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="/styles.css">
</head>
<body>
<div class="container">
    <h1>Eyyy Server</h1>

    <!-- Upload Section -->
    <div class="upload-section">
        <h2>Upload or else....</h2>
        <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
            <input type="file" name="media" accept="image/*,video/*" multiple required>
            <button type="submit">Upload</button>
        </form>
    </div>

    <!-- Gallery -->
    <h2>Gallery</h2>
    <% if (mediaFiles.length > 0) { %>
        <div class="gallery">
            <% mediaFiles.forEach(file => { %>
                <div class="gallery-item" onclick="openFullViewModal('<%= file %>')">
                    <% if (file.match(/\.(mp4|mov|avi|webm)$/i)) { %>
                        <div class="media-icon"><i class="fas fa-video"></i> Video</div>
                        <!-- Static video thumbnail -->
                        <img src="/uploads/<%= file %>#t=0.1" alt="Video thumbnail">
                    <% } else { %>
                        <div class="media-icon"><i class="fas fa-image"></i> Photo</div>
                        <img src="/uploads/<%= file %>" alt="<%= file %>">
                    <% } %>
                </div>
            <% }); %>
        </div>
    <% } else { %>
        <p class="no-media">No photos or videos uploaded yet. Upload some to get started!</p>
    <% } %>
</div>

<!-- Full View Modal -->
<div id="fullViewModal" class="modal">
    <div class="modal-content">
        <button class="close-button" onclick="closeFullViewModal()">&times;</button>
        <div id="fullViewMediaContainer"></div>
        <div class="full-view-modal-actions">
            <a href="#" id="fullViewDownloadBtn" class="download">Download</a>
            <button type="button" class="delete" id="fullViewDeleteBtn">Delete</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="confirmDeleteModal" class="modal">
    <div class="modal-content">
        <p>Are you sure you want to delete this file?</p>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
            <button id="confirmDeleteYes" class="delete">Yes, delete</button>
            <button id="confirmDeleteNo" class="download">Cancel</button>
        </div>
    </div>
</div>

<!-- Uploading Modal -->
<div id="uploadingModal" class="modal">
    <div class="modal-content">
        <p>Uploading files, please wait...</p>
        <div class="loader"></div>
    </div>
</div>

<script>
    // Modal elements
    const fullViewModal = document.getElementById('fullViewModal');
    const fullViewMediaContainer = document.getElementById('fullViewMediaContainer');
    const fullViewDownloadBtn = document.getElementById('fullViewDownloadBtn');
    const fullViewDeleteBtn = document.getElementById('fullViewDeleteBtn');
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    const confirmYes = document.getElementById('confirmDeleteYes');
    const confirmNo = document.getElementById('confirmDeleteNo');
    const uploadingModal = document.getElementById('uploadingModal');

    let currentFilename = '';

    // Full view modal
    function openFullViewModal(filename) {
        fullViewMediaContainer.innerHTML = '';
        currentFilename = filename;
        const ext = filename.split('.').pop().toLowerCase();
        let media;

        if (['mp4','mov','avi','webm'].includes(ext)) {
            media = document.createElement('video');
            media.src = `/uploads/${filename}`;
            media.controls = true;
            media.autoplay = true;
            media.playsInline = true;
            media.classList.add('modal-media');
        } else {
            media = document.createElement('img');
            media.src = `/uploads/${filename}`;
            media.alt = filename;
            media.classList.add('modal-media');
        }

        fullViewMediaContainer.appendChild(media);
        fullViewDownloadBtn.href = `/download/${filename}`;
        fullViewDeleteBtn.onclick = () => showModal(confirmDeleteModal);
        showModal(fullViewModal);
    }

    function closeFullViewModal() {
        fullViewMediaContainer.innerHTML = '';
        hideModal(fullViewModal);
    }

    // Delete confirmation
    confirmYes.onclick = () => {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete/${currentFilename}`;
        document.body.appendChild(form);
        form.submit();
    };
    confirmNo.onclick = () => hideModal(confirmDeleteModal);

    // Show/hide modal
    function showModal(modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
    }
    function hideModal(modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display='none', 300);
    }

    // Close modals on click outside
    window.onclick = e => {
        if(e.target==fullViewModal) hideModal(fullViewModal);
        if(e.target==confirmDeleteModal) hideModal(confirmDeleteModal);
    };

    // Uploading modal
    const uploadForm = document.getElementById('uploadForm');
    uploadForm.addEventListener('submit', () => {
        uploadingModal.style.display = 'flex';
    });

    // WebSocket live reload
    const ws = new WebSocket(`ws://${window.location.host}`);
    ws.onmessage = event => { if(event.data==='reload') window.location.reload(); }
    ws.onopen = () => console.log('WebSocket connected');
    ws.onclose = () => setTimeout(()=>location.reload(),1000);
</script>
</body>
</html>
